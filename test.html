<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>음성 채팅 테스트</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .container {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
      }
      .chat-area {
        height: 300px;
        overflow-y: auto;
        border: 1px solid #ccc;
        padding: 10px;
        margin-bottom: 10px;
        background-color: #f9f9f9;
      }
      .diary-area {
        height: 400px;
        overflow-y: auto;
        border: 1px solid #ccc;
        padding: 10px;
        margin-bottom: 10px;
        background-color: #fff8f0;
      }
      .message {
        margin-bottom: 10px;
        padding: 8px;
        border-radius: 5px;
      }
      .user-message {
        background-color: #e3f2fd;
        text-align: right;
      }
      .ai-message {
        background-color: #f1f8e9;
        text-align: left;
      }
      .voice-message {
        border-left: 4px solid #4caf50;
        padding-left: 12px;
      }
      .diary-item {
        margin-bottom: 20px;
        padding: 15px;
        border: 2px solid #ff9800;
        border-radius: 10px;
        background-color: #fff3e0;
      }
      .diary-image {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        margin: 10px 0;
      }
      .processing {
        color: #ff9800;
        font-style: italic;
      }
      .error {
        color: #f44336;
        font-weight: bold;
      }
      .success {
        color: #4caf50;
        font-weight: bold;
      }
      input,
      button {
        padding: 8px 12px;
        margin: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      button {
        background-color: #2196f3;
        color: white;
        cursor: pointer;
      }
      button:hover {
        background-color: #0b7dda;
      }
      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      .record-btn {
        background-color: #f44336;
        font-size: 16px;
        padding: 15px 20px;
      }
      .record-btn.recording {
        background-color: #ff9800;
        animation: pulse 1s infinite;
      }
      .diary-btn {
        background-color: #ff9800;
        font-size: 14px;
        padding: 10px 15px;
      }
      .diary-btn:hover {
        background-color: #f57c00;
      }
      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }
      .status {
        margin-top: 10px;
        padding: 10px;
        border-radius: 4px;
        display: none;
      }
      .status.show {
        display: block;
      }
      .status.processing {
        background-color: #fff3e0;
        color: #ef6c00;
      }
      .status.error {
        background-color: #ffebee;
        color: #c62828;
      }
      .status.success {
        background-color: #e8f5e8;
        color: #2e7d32;
      }
    </style>
  </head>
  <body>
    <h1>🎤 음성 채팅 테스트</h1>

    <div class="container">
      <h3>방 입장</h3>
      <input id="roomId" placeholder="방 번호 입력 (예: 123)" value="123" />
      <button onclick="joinRoom()">방 입장</button>
      <div id="roomStatus"></div>
    </div>

    <div class="container">
      <h3>채팅</h3>
      <div id="chatArea" class="chat-area"></div>

      <div>
        <input
          id="textMsg"
          placeholder="텍스트 메시지 입력"
          style="width: 300px"
        />
        <button onclick="sendTextMessage()">텍스트 전송</button>
      </div>

      <div style="margin-top: 10px">
        <button
          id="recordBtn"
          class="record-btn"
          onmousedown="startRecording()"
          onmouseup="stopRecording()"
        >
          🎤 길게 눌러서 음성 녹음
        </button>
      </div>

      <div id="status" class="status">
        <span id="statusText"></span>
      </div>
    </div>

    <div class="container">
      <h3>📖 그림일기 만들기</h3>
      <div>
        <input
          id="diaryRoomId"
          placeholder="일기를 만들 방 번호"
          style="width: 200px"
        />
        <button class="diary-btn" onclick="generateDiary()">
          🎨 일기 생성
        </button>
        <button class="diary-btn" onclick="getDiary()">📖 일기 조회</button>
        <button class="diary-btn" onclick="getAllDiaries()">
          📚 모든 일기 보기
        </button>
      </div>

      <div id="diaryStatus" class="status">
        <span id="diaryStatusText"></span>
      </div>

      <div id="diaryArea" class="diary-area">
        <p style="text-align: center; color: #999">일기가 표시될 영역입니다.</p>
      </div>
    </div>

    <div class="container">
      <h3>디버그 로그</h3>
      <textarea id="debugLog" cols="80" rows="8" readonly></textarea>
      <br />
      <button onclick="clearLog()">로그 지우기</button>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
      const socket = io('http://localhost:3000');
      const API_BASE_URL = 'http://localhost:3000';
      let mediaRecorder = null;
      let audioChunks = [];
      let isRecording = false;
      let currentRoomId = null;

      // 웹소켓 이벤트 리스너들
      socket.on('joinedRoom', (data) => {
        currentRoomId = data.roomId;
        document.getElementById('roomStatus').innerHTML =
          `<span style="color: green;">✅ 방 ${data.roomId}에 입장했습니다!</span>`;
        document.getElementById('diaryRoomId').value = data.roomId;
        log(`방 ${data.roomId} 입장 완료`);
      });

      // 메시지 수신 (핵심!)
      socket.on('message', (message) => {
        log(
          `메시지 수신: ${message.sender} - ${message.type} - ${message.text}`,
        );

        // 채팅 화면에 메시지 표시
        displayMessage(message);

        // AI 음성 메시지면 자동 재생
        if (
          message.sender === 'ai' &&
          message.type === 'voice' &&
          message.audioData
        ) {
          log('AI 음성 재생 시작');
          playAudio(message.audioData);
        }
      });

      // 처리 상태 알림
      socket.on('processing', (data) => {
        showStatus(data.message, 'processing');
        log(`처리 상태: ${data.stage} - ${data.message}`);
      });

      // 세션 타임아웃
      socket.on('sessionTimeout', (data) => {
        showStatus('대화가 종료되었습니다. 그림일기를 만들어보세요!', 'error');
        log(`세션 종료: ${data.message}`);
        alert(
          '20초 동안 응답이 없어서 대화가 종료되었습니다.\n그림일기를 만들어보세요!',
        );
      });

      // 에러 처리
      socket.on('error', (error) => {
        showStatus(`에러: ${error.message}`, 'error');
        log(`에러: ${error.message}`);
      });

      // 방 입장
      function joinRoom() {
        const roomId = document.getElementById('roomId').value;
        if (!roomId) {
          alert('방 번호를 입력하세요!');
          return;
        }
        socket.emit('joinRoom', { roomId: Number(roomId) });
        log(`방 입장 요청: ${roomId}`);
      }

      // 텍스트 메시지 전송
      function sendTextMessage() {
        const text = document.getElementById('textMsg').value.trim();
        if (!text || !currentRoomId) {
          alert('방에 먼저 입장하고 메시지를 입력하세요!');
          return;
        }

        socket.emit('sendMessage', {
          roomId: currentRoomId,
          text: text,
        });

        document.getElementById('textMsg').value = '';
        log(`텍스트 메시지 전송: ${text}`);
      }

      // 음성 녹음 시작
      function startRecording() {
        if (!currentRoomId) {
          alert('방에 먼저 입장하세요!');
          return;
        }

        if (isRecording) return;

        navigator.mediaDevices
          .getUserMedia({ audio: true })
          .then((stream) => {
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            isRecording = true;

            // 버튼 스타일 변경
            const btn = document.getElementById('recordBtn');
            btn.classList.add('recording');
            btn.textContent = '🔴 녹음 중... 놓으면 전송';

            mediaRecorder.ondataavailable = (event) => {
              audioChunks.push(event.data);
            };

            mediaRecorder.onstop = () => {
              const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
              sendVoiceMessage(audioBlob);

              // 스트림 정리
              stream.getTracks().forEach((track) => track.stop());
              isRecording = false;

              // 버튼 원복
              btn.classList.remove('recording');
              btn.textContent = '🎤 길게 눌러서 음성 녹음';
            };

            mediaRecorder.start();
            log('음성 녹음 시작');
            showStatus(
              '음성 녹음 중... 버튼을 놓으면 전송됩니다.',
              'processing',
            );
          })
          .catch((error) => {
            console.error('녹음 시작 실패:', error);
            alert('마이크 권한을 허용해주세요!');
            isRecording = false;
          });
      }

      // 음성 녹음 종료
      function stopRecording() {
        if (mediaRecorder && isRecording) {
          mediaRecorder.stop();
          log('음성 녹음 종료');
          showStatus('음성을 처리 중입니다...', 'processing');
        }
      }

      // 음성 메시지 전송 (핵심!)
      async function sendVoiceMessage(audioBlob) {
        try {
          log(`음성 파일 크기: ${audioBlob.size} bytes`);

          // Blob → Base64 변환
          const arrayBuffer = await audioBlob.arrayBuffer();
          const audioBase64 = btoa(
            String.fromCharCode(...new Uint8Array(arrayBuffer)),
          );

          log('Base64 변환 완료, 서버로 전송 중...');

          // 웹소켓으로 전송 (이게 전부!)
          socket.emit('sendVoiceMessage', {
            roomId: currentRoomId,
            audioData: audioBase64,
          });

          log('음성 메시지 전송 완료');
        } catch (error) {
          console.error('음성 전송 실패:', error);
          log(`음성 전송 에러: ${error.message}`);
          showStatus('음성 전송에 실패했습니다.', 'error');
        }
      }

      // 음성 재생 (중요!)
      function playAudio(base64Audio) {
        try {
          const audio = new Audio(`data:audio/wav;base64,${base64Audio}`);

          audio.onloadstart = () => log('음성 로딩 시작');
          audio.oncanplay = () => log('음성 재생 가능');
          audio.onplay = () => log('음성 재생 시작');
          audio.onended = () => log('음성 재생 완료');
          audio.onerror = (e) => log(`음성 재생 에러: ${e.message}`);

          audio.play().catch((error) => {
            console.error('음성 재생 실패:', error);
            log(`음성 재생 실패: ${error.message}`);
          });
        } catch (error) {
          console.error('음성 재생 준비 실패:', error);
          log(`음성 재생 준비 실패: ${error.message}`);
        }
      }

      // 일기 생성
      async function generateDiary() {
        const roomId = document.getElementById('diaryRoomId').value;
        if (!roomId) {
          alert('방 번호를 입력하세요!');
          return;
        }

        showDiaryStatus(
          '일기를 생성 중입니다... 잠시만 기다려주세요 🎨',
          'processing',
        );
        log(`일기 생성 요청: 방 ${roomId}`);

        try {
          const response = await fetch(`${API_BASE_URL}/diary/room/${roomId}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
          });

          if (response.ok) {
            const diary = await response.json();
            showDiaryStatus('일기가 성공적으로 생성되었습니다! 📖', 'success');
            displayDiary(diary);
            log(`일기 생성 완료: ${diary.id}`);
          } else {
            const error = await response.text();
            showDiaryStatus(`일기 생성 실패: ${error}`, 'error');
            log(`일기 생성 실패: ${error}`);
          }
        } catch (error) {
          showDiaryStatus(`네트워크 오류: ${error.message}`, 'error');
          log(`일기 생성 네트워크 오류: ${error.message}`);
        }
      }

      // 일기 조회
      async function getDiary() {
        const roomId = document.getElementById('diaryRoomId').value;
        if (!roomId) {
          alert('방 번호를 입력하세요!');
          return;
        }

        showDiaryStatus('일기를 조회 중입니다...', 'processing');
        log(`일기 조회 요청: 방 ${roomId}`);

        try {
          const response = await fetch(`${API_BASE_URL}/diary/room/${roomId}`);

          if (response.ok) {
            const diary = await response.json();
            if (diary) {
              showDiaryStatus('일기를 찾았습니다! 📖', 'success');
              displayDiary(diary);
              log(`일기 조회 완료: ${diary.id}`);
            } else {
              showDiaryStatus('해당 방의 일기가 없습니다.', 'error');
              document.getElementById('diaryArea').innerHTML =
                '<p style="text-align: center; color: #999;">해당 방의 일기가 없습니다.</p>';
              log(`일기 없음: 방 ${roomId}`);
            }
          } else {
            const error = await response.text();
            showDiaryStatus(`일기 조회 실패: ${error}`, 'error');
            log(`일기 조회 실패: ${error}`);
          }
        } catch (error) {
          showDiaryStatus(`네트워크 오류: ${error.message}`, 'error');
          log(`일기 조회 네트워크 오류: ${error.message}`);
        }
      }

      // 모든 일기 조회
      async function getAllDiaries() {
        showDiaryStatus('모든 일기를 조회 중입니다...', 'processing');
        log('모든 일기 조회 요청');

        try {
          const response = await fetch(`${API_BASE_URL}/diary`);

          if (response.ok) {
            const diaries = await response.json();
            showDiaryStatus(
              `총 ${diaries.length}개의 일기를 찾았습니다! 📚`,
              'success',
            );
            displayAllDiaries(diaries);
            log(`모든 일기 조회 완료: ${diaries.length}개`);
          } else {
            const error = await response.text();
            showDiaryStatus(`일기 목록 조회 실패: ${error}`, 'error');
            log(`일기 목록 조회 실패: ${error}`);
          }
        } catch (error) {
          showDiaryStatus(`네트워크 오류: ${error.message}`, 'error');
          log(`일기 목록 조회 네트워크 오류: ${error.message}`);
        }
      }

      // 단일 일기 표시
      function displayDiary(diary) {
        const diaryArea = document.getElementById('diaryArea');
        const formattedDate = new Date(diary.createdAt).toLocaleString('ko-KR');

        diaryArea.innerHTML = `
            <div class="diary-item">
                <h4>📖 방 ${diary.roomId}의 일기 (ID: ${diary.id})</h4>
                <p><strong>📅 생성일:</strong> ${formattedDate}</p>
                
                <h5>📝 일기 내용:</h5>
                <p style="background: white; padding: 10px; border-radius: 5px; border-left: 4px solid #ff9800;">
                    ${diary.content.replace(/\n/g, '<br>')}
                </p>
                
                <h5>💭 대화 요약:</h5>
                <p style="background: #f5f5f5; padding: 10px; border-radius: 5px;">
                    ${diary.summary.replace(/\n/g, '<br>')}
                </p>
                
                ${
                  diary.imageUrl
                    ? `
                    <h5>🎨 그림:</h5>
                    <img src="${diary.imageUrl}" class="diary-image" alt="일기 그림" />
                `
                    : '<p style="color: #999;">그림이 생성되지 않았습니다.</p>'
                }
            </div>
        `;
      }

      // 모든 일기 표시
      function displayAllDiaries(diaries) {
        const diaryArea = document.getElementById('diaryArea');

        if (diaries.length === 0) {
          diaryArea.innerHTML =
            '<p style="text-align: center; color: #999;">아직 생성된 일기가 없습니다.</p>';
          return;
        }

        let html = '';
        diaries.forEach((diary) => {
          const formattedDate = new Date(diary.createdAt).toLocaleString(
            'ko-KR',
          );
          html += `
                <div class="diary-item">
                    <h4>📖 방 ${diary.roomId}의 일기 (ID: ${diary.id})</h4>
                    <p><strong>📅 생성일:</strong> ${formattedDate}</p>
                    
                    <h5>📝 일기 내용:</h5>
                    <p style="background: white; padding: 10px; border-radius: 5px; border-left: 4px solid #ff9800;">
                        ${diary.content.replace(/\n/g, '<br>')}
                    </p>
                    
                    <h5>💭 대화 요약:</h5>
                    <p style="background: #f5f5f5; padding: 10px; border-radius: 5px;">
                        ${diary.summary.replace(/\n/g, '<br>')}
                    </p>
                    
                    ${
                      diary.imageUrl
                        ? `
                        <h5>🎨 그림:</h5>
                        <img src="${diary.imageUrl}" class="diary-image" alt="일기 그림" />
                    `
                        : '<p style="color: #999;">그림이 생성되지 않았습니다.</p>'
                    }
                </div>
            `;
        });

        diaryArea.innerHTML = html;
      }

      // 메시지를 화면에 표시
      function displayMessage(message) {
        const chatArea = document.getElementById('chatArea');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${message.sender === 'user' ? 'user-message' : 'ai-message'}`;

        let content = `<strong>${message.sender.toUpperCase()}:</strong> ${message.text}`;

        if (message.type === 'voice') {
          content += ' <span class="voice-message">🔊 음성</span>';
        }

        messageDiv.innerHTML = content;
        chatArea.appendChild(messageDiv);
        chatArea.scrollTop = chatArea.scrollHeight;
      }

      // 상태 메시지 표시
      function showStatus(message, type = 'processing') {
        const status = document.getElementById('status');
        const statusText = document.getElementById('statusText');

        statusText.textContent = message;
        status.className = `status show ${type}`;

        // 3초 후 자동 숨김 (에러가 아닌 경우)
        if (type !== 'error') {
          setTimeout(() => {
            status.classList.remove('show');
          }, 3000);
        }
      }

      // 일기 상태 메시지 표시
      function showDiaryStatus(message, type = 'processing') {
        const status = document.getElementById('diaryStatus');
        const statusText = document.getElementById('diaryStatusText');

        statusText.textContent = message;
        status.className = `status show ${type}`;

        // 5초 후 자동 숨김 (에러가 아닌 경우)
        if (type !== 'error') {
          setTimeout(() => {
            status.classList.remove('show');
          }, 5000);
        }
      }

      // 디버그 로그
      function log(message) {
        const timestamp = new Date().toLocaleTimeString();
        const logArea = document.getElementById('debugLog');
        logArea.value += `[${timestamp}] ${message}\n`;
        logArea.scrollTop = logArea.scrollHeight;
      }

      function clearLog() {
        document.getElementById('debugLog').value = '';
      }

      // Enter 키로 텍스트 메시지 전송
      document
        .getElementById('textMsg')
        .addEventListener('keypress', function (e) {
          if (e.key === 'Enter') {
            sendTextMessage();
          }
        });

      // Enter 키로 일기 방 번호 설정
      document
        .getElementById('diaryRoomId')
        .addEventListener('keypress', function (e) {
          if (e.key === 'Enter') {
            getDiary();
          }
        });

      // 초기 로그
      log('페이지 로드 완료. 방에 입장해주세요.');
    </script>
  </body>
</html>
