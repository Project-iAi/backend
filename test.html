<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ìŒì„± ì±„íŒ… í…ŒìŠ¤íŠ¸</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .container {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
      }
      .chat-area {
        height: 300px;
        overflow-y: auto;
        border: 1px solid #ccc;
        padding: 10px;
        margin-bottom: 10px;
        background-color: #f9f9f9;
      }
      .diary-area {
        height: 400px;
        overflow-y: auto;
        border: 1px solid #ccc;
        padding: 10px;
        margin-bottom: 10px;
        background-color: #fff8f0;
      }
      .message {
        margin-bottom: 10px;
        padding: 8px;
        border-radius: 5px;
      }
      .user-message {
        background-color: #e3f2fd;
        text-align: right;
      }
      .ai-message {
        background-color: #f1f8e9;
        text-align: left;
      }
      .voice-message {
        border-left: 4px solid #4caf50;
        padding-left: 12px;
      }
      .diary-item {
        margin-bottom: 20px;
        padding: 15px;
        border: 2px solid #ff9800;
        border-radius: 10px;
        background-color: #fff3e0;
      }
      .diary-image {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        margin: 10px 0;
      }
      .processing {
        color: #ff9800;
        font-style: italic;
      }
      .error {
        color: #f44336;
        font-weight: bold;
      }
      .success {
        color: #4caf50;
        font-weight: bold;
      }
      input,
      button {
        padding: 8px 12px;
        margin: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      button {
        background-color: #2196f3;
        color: white;
        cursor: pointer;
      }
      button:hover {
        background-color: #0b7dda;
      }
      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      .record-btn {
        background-color: #f44336;
        font-size: 16px;
        padding: 15px 20px;
      }
      .record-btn.recording {
        background-color: #ff9800;
        animation: pulse 1s infinite;
      }
      .diary-btn {
        background-color: #ff9800;
        font-size: 14px;
        padding: 10px 15px;
      }
      .diary-btn:hover {
        background-color: #f57c00;
      }
      .character-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin: 15px 0;
      }
      .character-card {
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        padding: 15px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
      }
      .character-card:hover {
        border-color: #2196f3;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      .character-card.selected {
        border-color: #4caf50;
        background-color: #e8f5e8;
      }
      .character-name {
        font-weight: bold;
        color: #333;
        margin-bottom: 5px;
      }
      .character-category {
        font-size: 12px;
        color: #666;
        background: #f5f5f5;
        padding: 2px 8px;
        border-radius: 10px;
        display: inline-block;
        margin-bottom: 8px;
      }
      .emotion-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin: 15px 0;
      }
      .emotion-card {
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
      }
      .emotion-card:hover {
        border-color: #2196f3;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      .emotion-card.selected {
        border-color: #4caf50;
        background-color: #e8f5e8;
      }
      .emotion-icon {
        font-size: 48px;
        margin-bottom: 8px;
      }
      .emotion-name {
        font-weight: bold;
        color: #333;
        font-size: 16px;
      }
      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }
      .status {
        margin-top: 10px;
        padding: 10px;
        border-radius: 4px;
        display: none;
      }
      .status.show {
        display: block;
      }
      .status.processing {
        background-color: #fff3e0;
        color: #ef6c00;
      }
      .status.error {
        background-color: #ffebee;
        color: #c62828;
      }
      .status.success {
        background-color: #e8f5e8;
        color: #2e7d32;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ¤ ìŒì„± ì±„íŒ… í…ŒìŠ¤íŠ¸</h1>

    <div class="container">
      <h3>ì§ì ‘ ë°© ì…ì¥ (ì„ íƒì‚¬í•­)</h3>
      <p style="color: #666; font-size: 14px">
        ê¸°ì¡´ ë°©ì— ì…ì¥í•˜ê±°ë‚˜ ìˆ˜ë™ìœ¼ë¡œ ë°©ì„ ìƒì„±í•˜ë ¤ë©´ ì‚¬ìš©í•˜ì„¸ìš”.
      </p>
      <input id="roomId" placeholder="ë°© ë²ˆí˜¸ ì…ë ¥ (ì˜ˆ: 123)" value="123" />
      <button onclick="joinRoom()">ë°© ì…ì¥</button>
      <div id="roomStatus"></div>
    </div>

    <div class="container">
      <h3>ğŸ­ ëŒ€í™” ì¹œêµ¬ ì„ íƒ</h3>
      <p style="color: #666; font-size: 14px">
        ëŒ€í™”í•  ì¹œêµ¬ë¥¼ ì„ íƒí•˜ë©´ ê°ì ë‹¤ë¥¸ ì„±ê²©ìœ¼ë¡œ ëŒ€í™”í•´ìš”!
      </p>

      <div>
        <button onclick="loadCharacters()" style="margin-bottom: 10px">
          ìºë¦­í„° ë¶ˆëŸ¬ì˜¤ê¸°
        </button>
      </div>

      <div id="characterStatus" class="status">
        <span id="characterStatusText"></span>
      </div>

      <div id="characterGrid" class="character-grid">
        <p style="text-align: center; color: #999; grid-column: 1/-1">
          ìºë¦­í„° ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”!
        </p>
      </div>
    </div>

    <div class="container" id="emotionContainer" style="display: none">
      <h3>ğŸ˜Š ì˜¤ëŠ˜ì˜ ê¸°ë¶„</h3>
      <p style="color: #666; font-size: 14px">
        ì˜¤ëŠ˜ ê¸°ë¶„ì´ ì–´ë•Œìš”? ì„ íƒí•˜ë©´ ì¹œêµ¬ê°€ ë” ì˜ ì´í•´í•´ì¤„ ê±°ì˜ˆìš”!
      </p>

      <div class="emotion-grid">
        <div
          class="emotion-card"
          onclick="selectEmotion('HAPPY')"
          data-emotion="HAPPY"
        >
          <div class="emotion-icon">ğŸ˜Š</div>
          <div class="emotion-name">ê¸°ì¨</div>
        </div>
        <div
          class="emotion-card"
          onclick="selectEmotion('SAD')"
          data-emotion="SAD"
        >
          <div class="emotion-icon">ğŸ˜¢</div>
          <div class="emotion-name">ìŠ¬í””</div>
        </div>
        <div
          class="emotion-card"
          onclick="selectEmotion('ANGRY')"
          data-emotion="ANGRY"
        >
          <div class="emotion-icon">ğŸ˜ </div>
          <div class="emotion-name">í™”ë‚¨</div>
        </div>
      </div>

      <div style="margin-top: 15px">
        <button
          onclick="startChatWithCharacterAndEmotion()"
          style="background-color: #4caf50; margin-right: 10px"
        >
          ğŸ’¬ ëŒ€í™” ì‹œì‘í•˜ê¸°
        </button>
        <button
          onclick="skipEmotionAndStartChat()"
          style="background-color: #ff9800"
        >
          ê±´ë„ˆë›°ê¸°
        </button>
      </div>

      <div id="emotionStatus" class="status">
        <span id="emotionStatusText"></span>
      </div>
    </div>

    <div class="container">
      <h3>ì±„íŒ…</h3>
      <div id="chatArea" class="chat-area"></div>

      <div>
        <input
          id="textMsg"
          placeholder="í…ìŠ¤íŠ¸ ë©”ì‹œì§€ ì…ë ¥"
          style="width: 300px"
        />
        <button onclick="sendTextMessage()">í…ìŠ¤íŠ¸ ì „ì†¡</button>
      </div>

      <div style="margin-top: 10px">
        <button
          id="recordBtn"
          class="record-btn"
          onmousedown="startRecording()"
          onmouseup="stopRecording()"
        >
          ğŸ¤ ê¸¸ê²Œ ëˆŒëŸ¬ì„œ ìŒì„± ë…¹ìŒ
        </button>
      </div>

      <div id="status" class="status">
        <span id="statusText"></span>
      </div>
    </div>

    <div class="container">
      <h3>ğŸ“– ê·¸ë¦¼ì¼ê¸° ë§Œë“¤ê¸°</h3>
      <div>
        <input
          id="diaryRoomId"
          placeholder="ì¼ê¸°ë¥¼ ë§Œë“¤ ë°© ë²ˆí˜¸"
          style="width: 200px"
        />
        <button class="diary-btn" onclick="generateDiary()">
          ğŸ¨ ì¼ê¸° ìƒì„±
        </button>
        <button class="diary-btn" onclick="getDiary()">ğŸ“– ì¼ê¸° ì¡°íšŒ</button>
        <button class="diary-btn" onclick="getAllDiaries()">
          ğŸ“š ëª¨ë“  ì¼ê¸° ë³´ê¸°
        </button>
      </div>

      <div id="diaryStatus" class="status">
        <span id="diaryStatusText"></span>
      </div>

      <div id="diaryArea" class="diary-area">
        <p style="text-align: center; color: #999">ì¼ê¸°ê°€ í‘œì‹œë  ì˜ì—­ì…ë‹ˆë‹¤.</p>
      </div>
    </div>

    <div class="container">
      <h3>ë””ë²„ê·¸ ë¡œê·¸</h3>
      <textarea id="debugLog" cols="80" rows="8" readonly></textarea>
      <br />
      <button onclick="clearLog()">ë¡œê·¸ ì§€ìš°ê¸°</button>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
      const socket = io('http://localhost:3000');
      const API_BASE_URL = 'http://localhost:3000';
      let mediaRecorder = null;
      let audioChunks = [];
      let isRecording = false;
      let currentRoomId = null;
      let selectedCharacterId = null;
      let allCharacters = [];
      let selectedEmotion = null; // ê°ì • ì„ íƒ ë³€ìˆ˜

      // ì›¹ì†Œì¼“ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤
      socket.on('joinedRoom', (data) => {
        currentRoomId = data.roomId;
        document.getElementById('roomStatus').innerHTML =
          `<span style="color: green;">âœ… ë°© ${data.roomId}ì— ì…ì¥í–ˆìŠµë‹ˆë‹¤!</span>`;
        document.getElementById('diaryRoomId').value = data.roomId;
        log(`ë°© ${data.roomId} ì…ì¥ ì™„ë£Œ`);
      });

      // ë©”ì‹œì§€ ìˆ˜ì‹  (í•µì‹¬!)
      socket.on('message', (message) => {
        log(
          `ë©”ì‹œì§€ ìˆ˜ì‹ : ${message.sender} - ${message.type} - ${message.text}`,
        );

        // ì±„íŒ… í™”ë©´ì— ë©”ì‹œì§€ í‘œì‹œ
        displayMessage(message);

        // AI ìŒì„± ë©”ì‹œì§€ë©´ ìë™ ì¬ìƒ
        if (
          message.sender === 'ai' &&
          message.type === 'voice' &&
          message.audioData
        ) {
          log('AI ìŒì„± ì¬ìƒ ì‹œì‘');
          playAudio(message.audioData);
        }
      });

      // ì²˜ë¦¬ ìƒíƒœ ì•Œë¦¼
      socket.on('processing', (data) => {
        showStatus(data.message, 'processing');
        log(`ì²˜ë¦¬ ìƒíƒœ: ${data.stage} - ${data.message}`);
      });

      // ì„¸ì…˜ íƒ€ì„ì•„ì›ƒ
      socket.on('sessionTimeout', (data) => {
        showStatus('ëŒ€í™”ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê·¸ë¦¼ì¼ê¸°ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”!', 'error');
        log(`ì„¸ì…˜ ì¢…ë£Œ: ${data.message}`);
        alert(
          '20ì´ˆ ë™ì•ˆ ì‘ë‹µì´ ì—†ì–´ì„œ ëŒ€í™”ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\nê·¸ë¦¼ì¼ê¸°ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”!',
        );
      });

      // ì—ëŸ¬ ì²˜ë¦¬
      socket.on('error', (error) => {
        showStatus(`ì—ëŸ¬: ${error.message}`, 'error');
        log(`ì—ëŸ¬: ${error.message}`);
      });

      // ë°© ì…ì¥
      function joinRoom() {
        const roomId = document.getElementById('roomId').value;
        if (!roomId) {
          alert('ë°© ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”!');
          return;
        }
        socket.emit('joinRoom', { roomId: Number(roomId) });
        log(`ë°© ì…ì¥ ìš”ì²­: ${roomId}`);
      }

      // í…ìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡
      function sendTextMessage() {
        const text = document.getElementById('textMsg').value.trim();
        if (!text || !currentRoomId) {
          alert('ë°©ì— ë¨¼ì € ì…ì¥í•˜ê³  ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”!');
          return;
        }

        socket.emit('sendMessage', {
          roomId: currentRoomId,
          text: text,
        });

        document.getElementById('textMsg').value = '';
        log(`í…ìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡: ${text}`);
      }

      // ìŒì„± ë…¹ìŒ ì‹œì‘
      function startRecording() {
        if (!currentRoomId) {
          alert('ë°©ì— ë¨¼ì € ì…ì¥í•˜ì„¸ìš”!');
          return;
        }

        if (isRecording) return;

        navigator.mediaDevices
          .getUserMedia({ audio: true })
          .then((stream) => {
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            isRecording = true;

            // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ë³€ê²½
            const btn = document.getElementById('recordBtn');
            btn.classList.add('recording');
            btn.textContent = 'ğŸ”´ ë…¹ìŒ ì¤‘... ë†“ìœ¼ë©´ ì „ì†¡';

            mediaRecorder.ondataavailable = (event) => {
              audioChunks.push(event.data);
            };

            mediaRecorder.onstop = () => {
              const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
              sendVoiceMessage(audioBlob);

              // ìŠ¤íŠ¸ë¦¼ ì •ë¦¬
              stream.getTracks().forEach((track) => track.stop());
              isRecording = false;

              // ë²„íŠ¼ ì›ë³µ
              btn.classList.remove('recording');
              btn.textContent = 'ğŸ¤ ê¸¸ê²Œ ëˆŒëŸ¬ì„œ ìŒì„± ë…¹ìŒ';
            };

            mediaRecorder.start();
            log('ìŒì„± ë…¹ìŒ ì‹œì‘');
            showStatus(
              'ìŒì„± ë…¹ìŒ ì¤‘... ë²„íŠ¼ì„ ë†“ìœ¼ë©´ ì „ì†¡ë©ë‹ˆë‹¤.',
              'processing',
            );
          })
          .catch((error) => {
            console.error('ë…¹ìŒ ì‹œì‘ ì‹¤íŒ¨:', error);
            alert('ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”!');
            isRecording = false;
          });
      }

      // ìŒì„± ë…¹ìŒ ì¢…ë£Œ
      function stopRecording() {
        if (mediaRecorder && isRecording) {
          mediaRecorder.stop();
          log('ìŒì„± ë…¹ìŒ ì¢…ë£Œ');
          showStatus('ìŒì„±ì„ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...', 'processing');
        }
      }

      // ìŒì„± ë©”ì‹œì§€ ì „ì†¡ (í•µì‹¬!)
      async function sendVoiceMessage(audioBlob) {
        try {
          log(`ìŒì„± íŒŒì¼ í¬ê¸°: ${audioBlob.size} bytes`);

          // Blob â†’ Base64 ë³€í™˜
          const arrayBuffer = await audioBlob.arrayBuffer();
          const audioBase64 = btoa(
            String.fromCharCode(...new Uint8Array(arrayBuffer)),
          );

          log('Base64 ë³€í™˜ ì™„ë£Œ, ì„œë²„ë¡œ ì „ì†¡ ì¤‘...');

          // ì›¹ì†Œì¼“ìœ¼ë¡œ ì „ì†¡ (ì´ê²Œ ì „ë¶€!)
          socket.emit('sendVoiceMessage', {
            roomId: currentRoomId,
            audioData: audioBase64,
          });

          log('ìŒì„± ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ');
        } catch (error) {
          console.error('ìŒì„± ì „ì†¡ ì‹¤íŒ¨:', error);
          log(`ìŒì„± ì „ì†¡ ì—ëŸ¬: ${error.message}`);
          showStatus('ìŒì„± ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
      }

      // ìŒì„± ì¬ìƒ (ì¤‘ìš”!)
      function playAudio(base64Audio) {
        try {
          const audio = new Audio(`data:audio/wav;base64,${base64Audio}`);

          audio.onloadstart = () => log('ìŒì„± ë¡œë”© ì‹œì‘');
          audio.oncanplay = () => log('ìŒì„± ì¬ìƒ ê°€ëŠ¥');
          audio.onplay = () => log('ìŒì„± ì¬ìƒ ì‹œì‘');
          audio.onended = () => log('ìŒì„± ì¬ìƒ ì™„ë£Œ');
          audio.onerror = (e) => log(`ìŒì„± ì¬ìƒ ì—ëŸ¬: ${e.message}`);

          audio.play().catch((error) => {
            console.error('ìŒì„± ì¬ìƒ ì‹¤íŒ¨:', error);
            log(`ìŒì„± ì¬ìƒ ì‹¤íŒ¨: ${error.message}`);
          });
        } catch (error) {
          console.error('ìŒì„± ì¬ìƒ ì¤€ë¹„ ì‹¤íŒ¨:', error);
          log(`ìŒì„± ì¬ìƒ ì¤€ë¹„ ì‹¤íŒ¨: ${error.message}`);
        }
      }

      // ì¼ê¸° ìƒì„±
      async function generateDiary() {
        const roomId = document.getElementById('diaryRoomId').value;
        if (!roomId) {
          alert('ë°© ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”!');
          return;
        }

        showDiaryStatus(
          'ì¼ê¸°ë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš” ğŸ¨',
          'processing',
        );
        log(`ì¼ê¸° ìƒì„± ìš”ì²­: ë°© ${roomId}`);

        try {
          const response = await fetch(`${API_BASE_URL}/diary/room/${roomId}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
          });

          if (response.ok) {
            const diary = await response.json();
            showDiaryStatus('ì¼ê¸°ê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“–', 'success');
            displayDiary(diary);
            log(`ì¼ê¸° ìƒì„± ì™„ë£Œ: ${diary.id}`);
          } else {
            const error = await response.text();
            showDiaryStatus(`ì¼ê¸° ìƒì„± ì‹¤íŒ¨: ${error}`, 'error');
            log(`ì¼ê¸° ìƒì„± ì‹¤íŒ¨: ${error}`);
          }
        } catch (error) {
          showDiaryStatus(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`, 'error');
          log(`ì¼ê¸° ìƒì„± ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`);
        }
      }

      // ì¼ê¸° ì¡°íšŒ
      async function getDiary() {
        const roomId = document.getElementById('diaryRoomId').value;
        if (!roomId) {
          alert('ë°© ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”!');
          return;
        }

        showDiaryStatus('ì¼ê¸°ë¥¼ ì¡°íšŒ ì¤‘ì…ë‹ˆë‹¤...', 'processing');
        log(`ì¼ê¸° ì¡°íšŒ ìš”ì²­: ë°© ${roomId}`);

        try {
          const response = await fetch(`${API_BASE_URL}/diary/room/${roomId}`);

          if (response.ok) {
            const diary = await response.json();
            if (diary) {
              showDiaryStatus('ì¼ê¸°ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤! ğŸ“–', 'success');
              displayDiary(diary);
              log(`ì¼ê¸° ì¡°íšŒ ì™„ë£Œ: ${diary.id}`);
            } else {
              showDiaryStatus('í•´ë‹¹ ë°©ì˜ ì¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
              document.getElementById('diaryArea').innerHTML =
                '<p style="text-align: center; color: #999;">í•´ë‹¹ ë°©ì˜ ì¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
              log(`ì¼ê¸° ì—†ìŒ: ë°© ${roomId}`);
            }
          } else {
            const error = await response.text();
            showDiaryStatus(`ì¼ê¸° ì¡°íšŒ ì‹¤íŒ¨: ${error}`, 'error');
            log(`ì¼ê¸° ì¡°íšŒ ì‹¤íŒ¨: ${error}`);
          }
        } catch (error) {
          showDiaryStatus(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`, 'error');
          log(`ì¼ê¸° ì¡°íšŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`);
        }
      }

      // ëª¨ë“  ì¼ê¸° ì¡°íšŒ
      async function getAllDiaries() {
        showDiaryStatus('ëª¨ë“  ì¼ê¸°ë¥¼ ì¡°íšŒ ì¤‘ì…ë‹ˆë‹¤...', 'processing');
        log('ëª¨ë“  ì¼ê¸° ì¡°íšŒ ìš”ì²­');

        try {
          const response = await fetch(`${API_BASE_URL}/diary`);

          if (response.ok) {
            const diaries = await response.json();
            showDiaryStatus(
              `ì´ ${diaries.length}ê°œì˜ ì¼ê¸°ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤! ğŸ“š`,
              'success',
            );
            displayAllDiaries(diaries);
            log(`ëª¨ë“  ì¼ê¸° ì¡°íšŒ ì™„ë£Œ: ${diaries.length}ê°œ`);
          } else {
            const error = await response.text();
            showDiaryStatus(`ì¼ê¸° ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: ${error}`, 'error');
            log(`ì¼ê¸° ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: ${error}`);
          }
        } catch (error) {
          showDiaryStatus(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`, 'error');
          log(`ì¼ê¸° ëª©ë¡ ì¡°íšŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`);
        }
      }

      // ë‹¨ì¼ ì¼ê¸° í‘œì‹œ
      function displayDiary(diary) {
        const diaryArea = document.getElementById('diaryArea');
        const formattedDate = new Date(diary.createdAt).toLocaleString('ko-KR');

        diaryArea.innerHTML = `
            <div class="diary-item">
                <h4>ğŸ“– ë°© ${diary.roomId}ì˜ ì¼ê¸° (ID: ${diary.id})</h4>
                <p><strong>ğŸ“… ìƒì„±ì¼:</strong> ${formattedDate}</p>
                
                <h5>ğŸ“ ì¼ê¸° ë‚´ìš©:</h5>
                <p style="background: white; padding: 10px; border-radius: 5px; border-left: 4px solid #ff9800;">
                    ${diary.content.replace(/\n/g, '<br>')}
                </p>
                
                <h5>ğŸ’­ ëŒ€í™” ìš”ì•½:</h5>
                <p style="background: #f5f5f5; padding: 10px; border-radius: 5px;">
                    ${diary.summary.replace(/\n/g, '<br>')}
                </p>
                
                ${
                  diary.imageUrl
                    ? `
                    <h5>ğŸ¨ ê·¸ë¦¼:</h5>
                    <img src="${diary.imageUrl}" class="diary-image" alt="ì¼ê¸° ê·¸ë¦¼" />
                `
                    : '<p style="color: #999;">ê·¸ë¦¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>'
                }
            </div>
        `;
      }

      // ëª¨ë“  ì¼ê¸° í‘œì‹œ
      function displayAllDiaries(diaries) {
        const diaryArea = document.getElementById('diaryArea');

        if (diaries.length === 0) {
          diaryArea.innerHTML =
            '<p style="text-align: center; color: #999;">ì•„ì§ ìƒì„±ëœ ì¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }

        let html = '';
        diaries.forEach((diary) => {
          const formattedDate = new Date(diary.createdAt).toLocaleString(
            'ko-KR',
          );
          html += `
                <div class="diary-item">
                    <h4>ğŸ“– ë°© ${diary.roomId}ì˜ ì¼ê¸° (ID: ${diary.id})</h4>
                    <p><strong>ğŸ“… ìƒì„±ì¼:</strong> ${formattedDate}</p>
                    
                    <h5>ğŸ“ ì¼ê¸° ë‚´ìš©:</h5>
                    <p style="background: white; padding: 10px; border-radius: 5px; border-left: 4px solid #ff9800;">
                        ${diary.content.replace(/\n/g, '<br>')}
                    </p>
                    
                    <h5>ğŸ’­ ëŒ€í™” ìš”ì•½:</h5>
                    <p style="background: #f5f5f5; padding: 10px; border-radius: 5px;">
                        ${diary.summary.replace(/\n/g, '<br>')}
                    </p>
                    
                    ${
                      diary.imageUrl
                        ? `
                        <h5>ğŸ¨ ê·¸ë¦¼:</h5>
                        <img src="${diary.imageUrl}" class="diary-image" alt="ì¼ê¸° ê·¸ë¦¼" />
                    `
                        : '<p style="color: #999;">ê·¸ë¦¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>'
                    }
                </div>
            `;
        });

        diaryArea.innerHTML = html;
      }

      // ë©”ì‹œì§€ë¥¼ í™”ë©´ì— í‘œì‹œ
      function displayMessage(message) {
        const chatArea = document.getElementById('chatArea');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${message.sender === 'user' ? 'user-message' : 'ai-message'}`;

        let content = `<strong>${message.sender.toUpperCase()}:</strong> ${message.text}`;

        if (message.type === 'voice') {
          content += ' <span class="voice-message">ğŸ”Š ìŒì„±</span>';
        }

        messageDiv.innerHTML = content;
        chatArea.appendChild(messageDiv);
        chatArea.scrollTop = chatArea.scrollHeight;
      }

      // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
      function showStatus(message, type = 'processing') {
        const status = document.getElementById('status');
        const statusText = document.getElementById('statusText');

        statusText.textContent = message;
        status.className = `status show ${type}`;

        // 3ì´ˆ í›„ ìë™ ìˆ¨ê¹€ (ì—ëŸ¬ê°€ ì•„ë‹Œ ê²½ìš°)
        if (type !== 'error') {
          setTimeout(() => {
            status.classList.remove('show');
          }, 3000);
        }
      }

      // ì¼ê¸° ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
      function showDiaryStatus(message, type = 'processing') {
        const status = document.getElementById('diaryStatus');
        const statusText = document.getElementById('diaryStatusText');

        statusText.textContent = message;
        status.className = `status show ${type}`;

        // 5ì´ˆ í›„ ìë™ ìˆ¨ê¹€ (ì—ëŸ¬ê°€ ì•„ë‹Œ ê²½ìš°)
        if (type !== 'error') {
          setTimeout(() => {
            status.classList.remove('show');
          }, 5000);
        }
      }

      // ë””ë²„ê·¸ ë¡œê·¸
      function log(message) {
        const timestamp = new Date().toLocaleTimeString();
        const logArea = document.getElementById('debugLog');
        logArea.value += `[${timestamp}] ${message}\n`;
        logArea.scrollTop = logArea.scrollHeight;
      }

      function clearLog() {
        document.getElementById('debugLog').value = '';
      }

      // Enter í‚¤ë¡œ í…ìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡
      document
        .getElementById('textMsg')
        .addEventListener('keypress', function (e) {
          if (e.key === 'Enter') {
            sendTextMessage();
          }
        });

      // Enter í‚¤ë¡œ ì¼ê¸° ë°© ë²ˆí˜¸ ì„¤ì •
      document
        .getElementById('diaryRoomId')
        .addEventListener('keypress', function (e) {
          if (e.key === 'Enter') {
            getDiary();
          }
        });

      // ìºë¦­í„° ë¶ˆëŸ¬ì˜¤ê¸°
      async function loadCharacters() {
        showCharacterStatus('ìºë¦­í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...', 'processing');
        log('ìºë¦­í„° ëª©ë¡ ìš”ì²­');

        try {
          const response = await fetch(`${API_BASE_URL}/characters`);

          if (response.ok) {
            allCharacters = await response.json();
            showCharacterStatus(
              `${allCharacters.length}ê°œì˜ ìºë¦­í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!`,
              'success',
            );
            displayCharacters(allCharacters);
            log(`ìºë¦­í„° ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ: ${allCharacters.length}ê°œ`);
          } else {
            const error = await response.text();
            showCharacterStatus(`ìºë¦­í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${error}`, 'error');
            log(`ìºë¦­í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${error}`);
          }
        } catch (error) {
          showCharacterStatus(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`, 'error');
          log(`ìºë¦­í„° ë¶ˆëŸ¬ì˜¤ê¸° ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`);
        }
      }

      // ìºë¦­í„° í‘œì‹œ
      function displayCharacters(characters) {
        const grid = document.getElementById('characterGrid');

        if (characters.length === 0) {
          grid.innerHTML =
            '<p style="text-align: center; color: #999; grid-column: 1/-1;">ìºë¦­í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }

        // ì¹´í…Œê³ ë¦¬ë³„ë¡œ ê·¸ë£¹í™”
        const categories = {};
        characters.forEach((char) => {
          if (!categories[char.category]) {
            categories[char.category] = [];
          }
          categories[char.category].push(char);
        });

        let html = '';

        // ì¹´í…Œê³ ë¦¬ë³„ë¡œ í‘œì‹œ
        Object.keys(categories).forEach((category) => {
          html += `<div style="grid-column: 1/-1; text-align: center; margin: 10px 0;">
            <h4 style="color: #333; margin: 0;">${category} ğŸŒŸ</h4>
          </div>`;

          categories[category].forEach((character) => {
            html += `
              <div class="character-card" onclick="selectCharacterCard(${character.id})" data-character-id="${character.id}">
                <div class="character-name">${character.name}</div>
                <div class="character-category">${character.category}</div>
              </div>
            `;
          });
        });

        grid.innerHTML = html;
      }

      // ìºë¦­í„° ì¹´ë“œ ì„ íƒ
      function selectCharacterCard(characterId) {
        // ì´ì „ ì„ íƒ í•´ì œ
        document.querySelectorAll('.character-card').forEach((card) => {
          card.classList.remove('selected');
        });

        // ìƒˆë¡œìš´ ì„ íƒ
        const selectedCard = document.querySelector(
          `[data-character-id="${characterId}"]`,
        );
        if (selectedCard) {
          selectedCard.classList.add('selected');
          selectedCharacterId = characterId;

          const character = allCharacters.find((c) => c.id === characterId);
          if (character) {
            showCharacterStatus(
              `${character.name}ì´(ê°€) ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤! ì´ì œ ì˜¤ëŠ˜ì˜ ê¸°ë¶„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.`,
              'success',
            );
            log(`ìºë¦­í„° ì„ íƒ: ${character.name} (${character.category})`);

            // ê°ì • ì„ íƒ í™”ë©´ í‘œì‹œ
            document.getElementById('emotionContainer').style.display = 'block';
            document
              .getElementById('emotionContainer')
              .scrollIntoView({ behavior: 'smooth' });
          }
        }
      }

      // ìºë¦­í„° ì„ íƒ í›„ ê°ì • ì„ íƒ
      function selectEmotion(emotion) {
        const emotionContainer = document.getElementById('emotionContainer');
        const emotionStatus = document.getElementById('emotionStatus');
        const emotionStatusText = document.getElementById('emotionStatusText');

        // ì´ì „ ì„ íƒ í•´ì œ
        document.querySelectorAll('.emotion-card').forEach((card) => {
          card.classList.remove('selected');
        });

        // ìƒˆë¡œìš´ ì„ íƒ
        const selectedCard = document.querySelector(
          `[data-emotion="${emotion}"]`,
        );
        if (selectedCard) {
          selectedCard.classList.add('selected');
          selectedEmotion = emotion; // ê°ì • ë³€ìˆ˜ ì—…ë°ì´íŠ¸
          emotionStatusText.textContent = `${emotion}ì´(ê°€) ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤!`;
          emotionStatus.className = 'status show success';
          log(`ê°ì • ì„ íƒ: ${emotion}`);
        }
      }

      // ê°ì • ì„ íƒ í›„ ëŒ€í™” ì‹œì‘
      async function startChatWithCharacterAndEmotion() {
        if (!selectedCharacterId) {
          alert('ë¨¼ì € ìºë¦­í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
          return;
        }

        if (!selectedEmotion) {
          alert('ë¨¼ì € ê°ì •ì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
          return;
        }

        showCharacterStatus(
          'ìºë¦­í„°ì™€ ê°ì •ì„ ë°˜ì˜í•œ ì±„íŒ…ë°©ì„ ìƒì„±í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...',
          'processing',
        );
        log(
          `ìºë¦­í„° ${selectedCharacterId}, ê°ì • ${selectedEmotion}ì™€ í•¨ê»˜ ì±„íŒ…ë°© ìƒì„± ìš”ì²­`,
        );

        try {
          // ìºë¦­í„°ì™€ ê°ì •ì„ ë°˜ì˜í•œ ì±„íŒ…ë°© ìƒì„±
          const response = await fetch(`${API_BASE_URL}/chat/room`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              characterId: selectedCharacterId,
              emotion: selectedEmotion,
            }),
          });

          if (response.ok) {
            const room = await response.json();
            const character = allCharacters.find(
              (c) => c.id === selectedCharacterId,
            );

            // ìë™ìœ¼ë¡œ ë°©ì— ì…ì¥
            socket.emit('joinRoom', { roomId: room.id });

            showCharacterStatus(
              `${character.name}ê³¼(ì™€) ${selectedEmotion} ê¸°ë¶„ìœ¼ë¡œ ëŒ€í™”ë°©ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰`,
              'success',
            );
            log(
              `ì±„íŒ…ë°© ìƒì„± ë° ì…ì¥ ì™„ë£Œ: ë°© ${room.id}, ìºë¦­í„° ${character.name}, ê°ì • ${selectedEmotion}`,
            );
          } else {
            const error = await response.text();
            showCharacterStatus(`ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨: ${error}`, 'error');
            log(`ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨: ${error}`);
          }
        } catch (error) {
          showCharacterStatus(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`, 'error');
          log(`ì±„íŒ…ë°© ìƒì„± ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`);
        }
      }

      // ê°ì • ê±´ë„ˆë›°ê¸° í›„ ëŒ€í™” ì‹œì‘
      async function skipEmotionAndStartChat() {
        if (!selectedCharacterId) {
          alert('ë¨¼ì € ìºë¦­í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
          return;
        }

        showCharacterStatus(
          'ìºë¦­í„°ì™€ í•¨ê»˜ ì±„íŒ…ë°©ì„ ìƒì„±í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...',
          'processing',
        );
        log(
          `ìºë¦­í„° ${selectedCharacterId}ì™€ í•¨ê»˜ ì±„íŒ…ë°© ìƒì„± ìš”ì²­ (ê°ì • ê±´ë„ˆë›°ê¸°)`,
        );

        try {
          // ìºë¦­í„°ì™€ í•¨ê»˜ ì±„íŒ…ë°© ìƒì„±
          const response = await fetch(`${API_BASE_URL}/chat/room`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              characterId: selectedCharacterId,
            }),
          });

          if (response.ok) {
            const room = await response.json();
            const character = allCharacters.find(
              (c) => c.id === selectedCharacterId,
            );

            // ìë™ìœ¼ë¡œ ë°©ì— ì…ì¥
            socket.emit('joinRoom', { roomId: room.id });

            showCharacterStatus(
              `${character.name}ê³¼(ì™€) ëŒ€í™”ë°©ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤! ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”! ğŸ‰`,
              'success',
            );
            log(
              `ì±„íŒ…ë°© ìƒì„± ë° ì…ì¥ ì™„ë£Œ: ë°© ${room.id}, ìºë¦­í„° ${character.name} (ê°ì • ê±´ë„ˆë›°ê¸°)`,
            );
          } else {
            const error = await response.text();
            showCharacterStatus(`ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨: ${error}`, 'error');
            log(`ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨: ${error}`);
          }
        } catch (error) {
          showCharacterStatus(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`, 'error');
          log(`ì±„íŒ…ë°© ìƒì„± ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`);
        }
      }

      // ìºë¦­í„° ì„ íƒ ì™„ë£Œ (ê¸°ì¡´ ìœ ì§€ - ê°œë³„ ìºë¦­í„° ë³€ê²½ìš©)
      async function selectCharacter() {
        if (!selectedCharacterId) {
          alert('ë¨¼ì € ìºë¦­í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
          return;
        }

        if (!currentRoomId) {
          alert('ë¨¼ì € ë°©ì— ì…ì¥í•´ì£¼ì„¸ìš”!');
          return;
        }

        showCharacterStatus('ìºë¦­í„°ë¥¼ ì„¤ì •í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...', 'processing');
        log(
          `ìºë¦­í„° ì„¤ì • ìš”ì²­: ë°© ${currentRoomId}, ìºë¦­í„° ${selectedCharacterId}`,
        );

        try {
          const response = await fetch(
            `${API_BASE_URL}/chat/room/${currentRoomId}/character`,
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                characterId: selectedCharacterId,
              }),
            },
          );

          if (response.ok) {
            const result = await response.json();
            const character = allCharacters.find(
              (c) => c.id === selectedCharacterId,
            );
            showCharacterStatus(
              `${character.name}ê³¼(ì™€) ëŒ€í™”ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤!`,
              'success',
            );
            log(`ìºë¦­í„° ì„¤ì • ì™„ë£Œ: ${character.name}`);
          } else {
            const error = await response.text();
            showCharacterStatus(`ìºë¦­í„° ì„¤ì • ì‹¤íŒ¨: ${error}`, 'error');
            log(`ìºë¦­í„° ì„¤ì • ì‹¤íŒ¨: ${error}`);
          }
        } catch (error) {
          showCharacterStatus(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`, 'error');
          log(`ìºë¦­í„° ì„¤ì • ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`);
        }
      }

      // ìºë¦­í„° ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
      function showCharacterStatus(message, type = 'processing') {
        const status = document.getElementById('characterStatus');
        const statusText = document.getElementById('characterStatusText');

        statusText.textContent = message;
        status.className = `status show ${type}`;

        // 5ì´ˆ í›„ ìë™ ìˆ¨ê¹€ (ì—ëŸ¬ê°€ ì•„ë‹Œ ê²½ìš°)
        if (type !== 'error') {
          setTimeout(() => {
            status.classList.remove('show');
          }, 5000);
        }
      }

      // ì´ˆê¸° ë¡œê·¸
      log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ. ë°©ì— ì…ì¥í•´ì£¼ì„¸ìš”.');

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ìºë¦­í„° ìë™ ë¶ˆëŸ¬ì˜¤ê¸°
      loadCharacters();
    </script>
  </body>
</html>
