<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŒì„± ì±„íŒ… í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .chat-area {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 5px;
        }
        .user-message {
            background-color: #e3f2fd;
            text-align: right;
        }
        .ai-message {
            background-color: #f1f8e9;
            text-align: left;
        }
        .voice-message {
            border-left: 4px solid #4caf50;
            padding-left: 12px;
        }
        .processing {
            color: #ff9800;
            font-style: italic;
        }
        .error {
            color: #f44336;
            font-weight: bold;
        }
        input, button {
            padding: 8px 12px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #2196f3;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #0b7dda;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .record-btn {
            background-color: #f44336;
            font-size: 16px;
            padding: 15px 20px;
        }
        .record-btn.recording {
            background-color: #ff9800;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
        .status.show {
            display: block;
        }
        .status.processing {
            background-color: #fff3e0;
            color: #ef6c00;
        }
        .status.error {
            background-color: #ffebee;
            color: #c62828;
        }
    </style>
</head>
<body>
<h1>ğŸ¤ ìŒì„± ì±„íŒ… í…ŒìŠ¤íŠ¸</h1>

<div class="container">
    <h3>ë°© ì…ì¥</h3>
    <input id="roomId" placeholder="ë°© ë²ˆí˜¸ ì…ë ¥ (ì˜ˆ: 123)" value="123" />
    <button onclick="joinRoom()">ë°© ì…ì¥</button>
    <div id="roomStatus"></div>
</div>

<div class="container">
    <h3>ì±„íŒ…</h3>
    <div id="chatArea" class="chat-area"></div>

    <div>
        <input id="textMsg" placeholder="í…ìŠ¤íŠ¸ ë©”ì‹œì§€ ì…ë ¥" style="width: 300px;" />
        <button onclick="sendTextMessage()">í…ìŠ¤íŠ¸ ì „ì†¡</button>
    </div>

    <div style="margin-top: 10px;">
        <button id="recordBtn" class="record-btn" onmousedown="startRecording()" onmouseup="stopRecording()">
            ğŸ¤ ê¸¸ê²Œ ëˆŒëŸ¬ì„œ ìŒì„± ë…¹ìŒ
        </button>
    </div>

    <div id="status" class="status">
        <span id="statusText"></span>
    </div>
</div>

<div class="container">
    <h3>ë””ë²„ê·¸ ë¡œê·¸</h3>
    <textarea id="debugLog" cols="80" rows="8" readonly></textarea>
    <br>
    <button onclick="clearLog()">ë¡œê·¸ ì§€ìš°ê¸°</button>
</div>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
    const socket = io('http://localhost:3000');
    let mediaRecorder = null;
    let audioChunks = [];
    let isRecording = false;
    let currentRoomId = null;

    // ì›¹ì†Œì¼“ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤
    socket.on('joinedRoom', (data) => {
        currentRoomId = data.roomId;
        document.getElementById('roomStatus').innerHTML =
            `<span style="color: green;">âœ… ë°© ${data.roomId}ì— ì…ì¥í–ˆìŠµë‹ˆë‹¤!</span>`;
        log(`ë°© ${data.roomId} ì…ì¥ ì™„ë£Œ`);
    });

    // ë©”ì‹œì§€ ìˆ˜ì‹  (í•µì‹¬!)
    socket.on('message', (message) => {
        log(`ë©”ì‹œì§€ ìˆ˜ì‹ : ${message.sender} - ${message.type} - ${message.text}`);

        // ì±„íŒ… í™”ë©´ì— ë©”ì‹œì§€ í‘œì‹œ
        displayMessage(message);

        // AI ìŒì„± ë©”ì‹œì§€ë©´ ìë™ ì¬ìƒ
        if (message.sender === 'ai' && message.type === 'voice' && message.audioData) {
            log('AI ìŒì„± ì¬ìƒ ì‹œì‘');
            playAudio(message.audioData);
        }
    });

    // ì²˜ë¦¬ ìƒíƒœ ì•Œë¦¼
    socket.on('processing', (data) => {
        showStatus(data.message, 'processing');
        log(`ì²˜ë¦¬ ìƒíƒœ: ${data.stage} - ${data.message}`);
    });

    // ì„¸ì…˜ íƒ€ì„ì•„ì›ƒ
    socket.on('sessionTimeout', (data) => {
        showStatus('ëŒ€í™”ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê·¸ë¦¼ì¼ê¸°ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”!', 'error');
        log(`ì„¸ì…˜ ì¢…ë£Œ: ${data.message}`);
        alert('20ì´ˆ ë™ì•ˆ ì‘ë‹µì´ ì—†ì–´ì„œ ëŒ€í™”ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\nê·¸ë¦¼ì¼ê¸° í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
    });

    // ì—ëŸ¬ ì²˜ë¦¬
    socket.on('error', (error) => {
        showStatus(`ì—ëŸ¬: ${error.message}`, 'error');
        log(`ì—ëŸ¬: ${error.message}`);
    });

    // ë°© ì…ì¥
    function joinRoom() {
        const roomId = document.getElementById('roomId').value;
        if (!roomId) {
            alert('ë°© ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”!');
            return;
        }
        socket.emit('joinRoom', { roomId: Number(roomId) });
        log(`ë°© ì…ì¥ ìš”ì²­: ${roomId}`);
    }

    // í…ìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡
    function sendTextMessage() {
        const text = document.getElementById('textMsg').value.trim();
        if (!text || !currentRoomId) {
            alert('ë°©ì— ë¨¼ì € ì…ì¥í•˜ê³  ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”!');
            return;
        }

        socket.emit('sendMessage', {
            roomId: currentRoomId,
            text: text
        });

        document.getElementById('textMsg').value = '';
        log(`í…ìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡: ${text}`);
    }

    // ìŒì„± ë…¹ìŒ ì‹œì‘
    function startRecording() {
        if (!currentRoomId) {
            alert('ë°©ì— ë¨¼ì € ì…ì¥í•˜ì„¸ìš”!');
            return;
        }

        if (isRecording) return;

        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                isRecording = true;

                // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ë³€ê²½
                const btn = document.getElementById('recordBtn');
                btn.classList.add('recording');
                btn.textContent = 'ğŸ”´ ë…¹ìŒ ì¤‘... ë†“ìœ¼ë©´ ì „ì†¡';

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    sendVoiceMessage(audioBlob);

                    // ìŠ¤íŠ¸ë¦¼ ì •ë¦¬
                    stream.getTracks().forEach(track => track.stop());
                    isRecording = false;

                    // ë²„íŠ¼ ì›ë³µ
                    btn.classList.remove('recording');
                    btn.textContent = 'ğŸ¤ ê¸¸ê²Œ ëˆŒëŸ¬ì„œ ìŒì„± ë…¹ìŒ';
                };

                mediaRecorder.start();
                log('ìŒì„± ë…¹ìŒ ì‹œì‘');
                showStatus('ìŒì„± ë…¹ìŒ ì¤‘... ë²„íŠ¼ì„ ë†“ìœ¼ë©´ ì „ì†¡ë©ë‹ˆë‹¤.', 'processing');
            })
            .catch(error => {
                console.error('ë…¹ìŒ ì‹œì‘ ì‹¤íŒ¨:', error);
                alert('ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”!');
                isRecording = false;
            });
    }

    // ìŒì„± ë…¹ìŒ ì¢…ë£Œ
    function stopRecording() {
        if (mediaRecorder && isRecording) {
            mediaRecorder.stop();
            log('ìŒì„± ë…¹ìŒ ì¢…ë£Œ');
            showStatus('ìŒì„±ì„ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...', 'processing');
        }
    }

    // ìŒì„± ë©”ì‹œì§€ ì „ì†¡ (í•µì‹¬!)
    async function sendVoiceMessage(audioBlob) {
        try {
            log(`ìŒì„± íŒŒì¼ í¬ê¸°: ${audioBlob.size} bytes`);

            // Blob â†’ Base64 ë³€í™˜
            const arrayBuffer = await audioBlob.arrayBuffer();
            const audioBase64 = btoa(String.fromCharCode(...new Uint8Array(arrayBuffer)));

            log('Base64 ë³€í™˜ ì™„ë£Œ, ì„œë²„ë¡œ ì „ì†¡ ì¤‘...');

            // ì›¹ì†Œì¼“ìœ¼ë¡œ ì „ì†¡ (ì´ê²Œ ì „ë¶€!)
            socket.emit('sendVoiceMessage', {
                roomId: currentRoomId,
                audioData: audioBase64
            });

            log('ìŒì„± ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ');

        } catch (error) {
            console.error('ìŒì„± ì „ì†¡ ì‹¤íŒ¨:', error);
            log(`ìŒì„± ì „ì†¡ ì—ëŸ¬: ${error.message}`);
            showStatus('ìŒì„± ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ìŒì„± ì¬ìƒ (ì¤‘ìš”!)
    function playAudio(base64Audio) {
        try {
            const audio = new Audio(`data:audio/wav;base64,${base64Audio}`);

            audio.onloadstart = () => log('ìŒì„± ë¡œë”© ì‹œì‘');
            audio.oncanplay = () => log('ìŒì„± ì¬ìƒ ê°€ëŠ¥');
            audio.onplay = () => log('ìŒì„± ì¬ìƒ ì‹œì‘');
            audio.onended = () => log('ìŒì„± ì¬ìƒ ì™„ë£Œ');
            audio.onerror = (e) => log(`ìŒì„± ì¬ìƒ ì—ëŸ¬: ${e.message}`);

            audio.play().catch(error => {
                console.error('ìŒì„± ì¬ìƒ ì‹¤íŒ¨:', error);
                log(`ìŒì„± ì¬ìƒ ì‹¤íŒ¨: ${error.message}`);
            });
        } catch (error) {
            console.error('ìŒì„± ì¬ìƒ ì¤€ë¹„ ì‹¤íŒ¨:', error);
            log(`ìŒì„± ì¬ìƒ ì¤€ë¹„ ì‹¤íŒ¨: ${error.message}`);
        }
    }

    // ë©”ì‹œì§€ë¥¼ í™”ë©´ì— í‘œì‹œ
    function displayMessage(message) {
        const chatArea = document.getElementById('chatArea');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${message.sender === 'user' ? 'user-message' : 'ai-message'}`;

        let content = `<strong>${message.sender.toUpperCase()}:</strong> ${message.text}`;

        if (message.type === 'voice') {
            content += ' <span class="voice-message">ğŸ”Š ìŒì„±</span>';
        }

        messageDiv.innerHTML = content;
        chatArea.appendChild(messageDiv);
        chatArea.scrollTop = chatArea.scrollHeight;
    }

    // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
    function showStatus(message, type = 'processing') {
        const status = document.getElementById('status');
        const statusText = document.getElementById('statusText');

        statusText.textContent = message;
        status.className = `status show ${type}`;

        // 3ì´ˆ í›„ ìë™ ìˆ¨ê¹€ (ì—ëŸ¬ê°€ ì•„ë‹Œ ê²½ìš°)
        if (type !== 'error') {
            setTimeout(() => {
                status.classList.remove('show');
            }, 3000);
        }
    }

    // ë””ë²„ê·¸ ë¡œê·¸
    function log(message) {
        const timestamp = new Date().toLocaleTimeString();
        const logArea = document.getElementById('debugLog');
        logArea.value += `[${timestamp}] ${message}\n`;
        logArea.scrollTop = logArea.scrollHeight;
    }

    function clearLog() {
        document.getElementById('debugLog').value = '';
    }

    // Enter í‚¤ë¡œ í…ìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡
    document.getElementById('textMsg').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendTextMessage();
        }
    });

    // ì´ˆê¸° ë¡œê·¸
    log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ. ë°©ì— ì…ì¥í•´ì£¼ì„¸ìš”.');
</script>
</body>
</html>